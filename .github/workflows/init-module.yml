name: Init Module (set slug + module.json)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize module scaffold (Flat Hierarchy)
        shell: bash
        run: |
          set -euo pipefail

          SLUG="${GITHUB_REPOSITORY##*/}"
          echo "Repo slug: ${SLUG}"

          # 1) Main PHP File: <slug>.php in ROOT
          # If we have a single folder "plugin", move its contents to root
          if [ -d "plugin" ]; then
            mv plugin/* .
            rmdir plugin
          fi

          # Rename generic generic.php/plugin.php/index.php to <slug>.php
          if [ ! -f "${SLUG}.php" ]; then
            if [ -f "plugin.php" ]; then
              mv "plugin.php" "${SLUG}.php"
            elif [ -f "index.php" ]; then
              mv "index.php" "${SLUG}.php"
            elif [ -f "kiw-module-template.php" ]; then
               mv "kiw-module-template.php" "${SLUG}.php"
            else
              # If exact one *.php in root, take it
              mapfile -t PHP_FILES < <(find . -maxdepth 1 -type f -name "*.php" | sort || true)
              if [ "${#PHP_FILES[@]}" -eq 1 ]; then
                mv "${PHP_FILES[0]}" "${SLUG}.php"
              else
                echo "WARNING: Could not auto-rename main PHP file to ${SLUG}.php"
                echo "Please ensure main file is named: ${SLUG}.php manually."
                ls -la
              fi
            fi
          fi

          # 2) Update Plugin Header
          if [ -f "${SLUG}.php" ]; then
              sed -i "s/^Plugin Name: .*$/Plugin Name: ${SLUG}/" "${SLUG}.php" || true
              sed -i "s/^Description: .*$/Description: KIW private module (${SLUG})./" "${SLUG}.php" || true
          fi

          # 3) Write module.json in ROOT
          cat > module.json <<JSON
          {
            "schema": 1,
            "name": "${SLUG}",
            "slug": "${SLUG}",
            "version": "0.1.0",
            "type": "module",
            "entry": "${SLUG}.php",
            "description": "KIW private module (${SLUG}).",
            "author": "KIW",
            "license": "GPLv2 or later",
            "text_domain": "${SLUG}",
            "namespace": "KIW\\\\${SLUG//-/_}",
            "requires": {
                "php": ">=8.3",
                "wp": ">=6.0"
            },
            "categories": [ "admin" ],
            "visibility": "public"
          }
          JSON

      - name: Commit & Push
        run: |
          git config user.name  "kiw-bot"
          git config user.email "kiw-bot@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: init module scaffold (flat hierarchy)"
          git push origin HEAD:main
