name: Build & GitHub Release (WordPress ZIP) + Trigger KIW Suite Sync

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  KIW_SUITE_OWNER: kiwerkepro-org
  KIW_SUITE_REPO: kiw-suite
  DISPATCH_EVENT_TYPE: module_release

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build WordPress ZIP (single root folder)
        shell: bash
        run: |
          set -euo pipefail

          SLUG="${GITHUB_REPOSITORY##*/}"
          TAG="${GITHUB_REF_NAME}"          # z.B. v0.1.2
          VERSION="${TAG#v}"                # z.B. 0.1.2 (nur für Logs)

          echo "SLUG=${SLUG}"
          echo "TAG=${TAG}"
          echo "VERSION=${VERSION}"

          # Erwartete Struktur nach Init-Workflow:
          test -f "${SLUG}/${SLUG}.php"

          mkdir -p releases

          # Asset-Name: <slug>-vX.Y.Z.zip
          ZIP="releases/${SLUG}-${TAG}.zip"

          # ZIP enthält GENAU 1 Root-Folder: <slug>/
          zip -r -q "${ZIP}" "${SLUG}"

          # Hard-fail: doppelte Verschachtelung
          if unzip -l "${ZIP}" | grep -q "${SLUG}/${SLUG}/"; then
            echo "ERROR: ZIP has double-nested folder ${SLUG}/${SLUG}/"
            unzip -l "${ZIP}" | head -n 120
            exit 1
          fi

          echo "Built: ${ZIP}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*.zip

      - name: Trigger KIW Suite sync (repository_dispatch)
        shell: bash
        env:
          DISPATCH_TOKEN: ${{ secrets.KIW_SUITE_DISPATCH_TOKEN }}
          OWNER: ${{ env.KIW_SUITE_OWNER }}
          REPO: ${{ env.KIW_SUITE_REPO }}
          EVENT_TYPE: ${{ env.DISPATCH_EVENT_TYPE }}
          MODULE_REPO: ${{ github.repository }}
          MODULE_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if [ -z "${DISPATCH_TOKEN:-}" ]; then
            echo "ERROR: Missing secret: KIW_SUITE_DISPATCH_TOKEN (Org Secret, All repositories)"
            exit 1
          fi

          # Kleine Verzögerung, damit Release/Assets sicher verfügbar sind
          sleep 10

          API="https://api.github.com/repos/${OWNER}/${REPO}/dispatches"
          echo "[KIW] Dispatch -> ${API}"
          echo "[KIW] event_type=${EVENT_TYPE} payload repo=${MODULE_REPO} tag=${MODULE_TAG}"

          curl -fsSL -X POST "${API}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${DISPATCH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\":\"${EVENT_TYPE}\",\"client_payload\":{\"module_repo\":\"${MODULE_REPO}\",\"module_tag\":\"${MODULE_TAG}\"}}"

          echo "[KIW] Dispatch sent."
