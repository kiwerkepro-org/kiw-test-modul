name: Build & GitHub Release (WordPress ZIP) + Trigger KIW Suite Sync

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  KIW_SUITE_OWNER: kiwerkepro-org
  KIW_SUITE_REPO: kiw-suite
  DISPATCH_EVENT_TYPE: module_release

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build WordPress ZIP (Flat Hierarchy)
        shell: bash
        run: |
          set -euo pipefail

          SLUG="${GITHUB_REPOSITORY##*/}"
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"

          echo "SLUG=${SLUG}"
          echo "TAG=${TAG}"

          # 1. Check for module.json in ROOT
          if [ ! -f "module.json" ]; then
            echo "ERROR: module.json not found in root!"
            ls -la
            exit 1
          fi

          # 2. Prepare Build Directory
          BUILD_DIR="build_tmp/${SLUG}"
          mkdir -p "${BUILD_DIR}"

          # 3. Copy files to slug-folder (excluding .git, .github, releases, etc.)
          # Using rsync if available, or simple cp with exclusions logic is tricky in strict bash without array.
          # Simplest robust way: enable dotglob and loop, skipping specifics.

          rsync -av --exclude='.git*' --exclude='releases' --exclude='build_tmp' --exclude='.github' . "${BUILD_DIR}/"

          # 4. create releases folder
          mkdir -p releases
          ZIP="releases/${SLUG}.zip"

          # 5. Zip the slug folder
          cd build_tmp
          zip -r -q "../${ZIP}" "${SLUG}"
          cd ..

          echo "Contents of zip:"
          unzip -l "${ZIP}" | head -n 20

          echo "Built: ${ZIP}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*.zip

      - name: Trigger KIW Suite sync (repository_dispatch)
        shell: bash
        env:
          DISPATCH_TOKEN: ${{ secrets.KIW_GH_PAT }}
          OWNER: ${{ env.KIW_SUITE_OWNER }}
          REPO: ${{ env.KIW_SUITE_REPO }}
          EVENT_TYPE: ${{ env.DISPATCH_EVENT_TYPE }}
          MODULE_REPO: ${{ github.repository }}
          MODULE_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if [ -z "${DISPATCH_TOKEN:-}" ]; then
            echo "ERROR: Missing secret: KIW_SUITE_DISPATCH_TOKEN (Org Secret, All repositories)"
            exit 1
          fi

          # Kleine Verzögerung, damit Release/Assets sicher verfügbar sind
          sleep 10

          API="https://api.github.com/repos/${OWNER}/${REPO}/dispatches"
          echo "[KIW] Dispatch -> ${API}"
          echo "[KIW] event_type=${EVENT_TYPE} payload repo=${MODULE_REPO} tag=${MODULE_TAG}"

          curl -fsSL -X POST "${API}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${DISPATCH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\":\"${EVENT_TYPE}\",\"client_payload\":{\"module_repo\":\"${MODULE_REPO}\",\"module_tag\":\"${MODULE_TAG}\"}}"

          echo "[KIW] Dispatch sent."
