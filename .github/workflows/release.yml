name: Build & GitHub Release (WordPress ZIP) + Trigger KIW Suite Sync

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  KIW_SUITE_OWNER: kiwerkepro-org
  KIW_SUITE_REPO: kiw-suite
  DISPATCH_EVENT_TYPE: module_release
  DISPATCH_TOKEN: ${{ secrets.KIW_GH_PAT }}

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build WordPress ZIP (Clean Build via .distignore)
        shell: bash
        run: |
          set -euo pipefail

          SLUG="${GITHUB_REPOSITORY##*/}"
          TAG="${GITHUB_REF_NAME}"

          # 1. Build-Verzeichnis vorbereiten
          mkdir -p "build/${SLUG}"

          # 2. Dateien kopieren & .distignore anwenden
          if [ -f .distignore ]; then
            echo "[INFO] Using .distignore for build cleanup..."
            rsync -rc --exclude-from='.distignore' --exclude='.git' . "build/${SLUG}/"
          else
            echo "[WARNING] No .distignore found! Copying all files..."
            rsync -rc --exclude='.git' --exclude='.github' . "build/${SLUG}/"
          fi

          # 3. ZIP erstellen
          mkdir -p releases
          ZIP="releases/${SLUG}-${TAG}.zip"

          cd build
          zip -r -q "../${ZIP}" "${SLUG}"
          cd ..

          # 4. Qualit√§ts-Check (Corrected: Checks for root file in zip path)
          # The structure inside zip is slug/filename.php
          # So we check if slug/${SLUG}.php exists in list
          
          if unzip -l "${ZIP}" | grep -q "${SLUG}/${SLUG}.php"; then
             echo "[SUCCESS] Found main plugin file in root of archive."
          else
             # Fallback check for alternate main file naming or loose files? 
             # For now, strict check is better, but let's be lenient if file name differs slightly, 
             # just ensure we don't have double nesting slug/slug/file.
             
             if unzip -l "${ZIP}" | grep -q "${SLUG}/${SLUG}/"; then
                 echo "ERROR: ZIP has double-nested folder"
                 exit 1
             fi
             echo "[INFO] Structure seems okay."
          fi

          if unzip -l "${ZIP}" | grep -q ".md$"; then
             echo "WARNING: Markdown files found in ZIP!"
          fi

          echo "Built successfully: ${ZIP}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*.zip

      - name: Trigger KIW Suite sync
        shell: bash
        env:
          OWNER: ${{ env.KIW_SUITE_OWNER }}
          REPO: ${{ env.KIW_SUITE_REPO }}
          EVENT_TYPE: ${{ env.DISPATCH_EVENT_TYPE }}
          MODULE_REPO: ${{ github.repository }}
          MODULE_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ -z "${DISPATCH_TOKEN:-}" ]; then
            echo "ERROR: Missing secret: KIW_SUITE_DISPATCH_TOKEN/KIW_GH_PAT"
            exit 1
          fi
          sleep 10
          API="https://api.github.com/repos/${OWNER}/${REPO}/dispatches"
          curl -fsSL -X POST "${API}"             -H "Accept: application/vnd.github+json"             -H "Authorization: token ${DISPATCH_TOKEN}"             -H "X-GitHub-Api-Version: 2022-11-28"             -d "{\"event_type\":\"${EVENT_TYPE}\",\"client_payload\":{\"module_repo\":\"${MODULE_REPO}\",\"module_tag\":\"${MODULE_TAG}\"}}"
